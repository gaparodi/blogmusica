{% extends "musica/base.html" %}
{% load static %}

{% block title %}
  {% firstof nota.titulo nota.nombre "Nota" %} · Blog Música
{% endblock %}

{% block content %}
<div class="container">
  <article class="mb-4">

    {% firstof nota.titulo nota.nombre "Nota" as nt %}
    <h1 class="mb-2">{{ nt }}</h1>

    <div class="text-muted mb-3">
      {% firstof nota.created_at nota.creado_at nota.fecha nota.fecha_publicacion as ndt %}
      {% if ndt %}<small>{{ ndt|date:"d/m/Y H:i" }}</small>{% endif %}
    </div>

    {% if image_url %}
      <img src="{{ image_url }}" class="img-fluid rounded mb-3" alt="{{ nt }}">
    {% endif %}

    {% firstof nota.contenido nota.descripcion nota.texto nota.resumen as body %}
    {% if body %}
      <div class="fs-5" style="line-height:1.7">{{ body|safe }}</div>
    {% else %}
      <p class="text-muted">Sin contenido.</p>
    {% endif %}

  </article>

  <!-- Comentarios -->
  <section class="mt-5">
    <h5 class="mb-3">Comentarios</h5>

    {% if comentarios %}
      <div class="vstack gap-3">
        {% for c in comentarios %}
          <div class="bg-white border rounded-3 shadow-sm p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">
                {% firstof c.autor.get_full_name c.autor.username c.autor "Anónimo" %}
              </div>
              <small class="text-muted">
                {% firstof c.created_at c.creado_at c.fecha as cdt %}
                {% if cdt %}{{ cdt|date:"d/m/Y H:i" }}{% endif %}
              </small>
            </div>
            {% firstof c.texto c.contenido c.body c.mensaje as ctext %}
            <div class="text-body">{{ ctext|linebreaksbr }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="bg-white border rounded-3 p-3 text-muted">Sé el primero en comentar.</div>
    {% endif %}

    {% if form %}
      <form method="post" class="mt-4">
        {% csrf_token %}
        <div class="mb-3">
          {{ form.non_field_errors }}
          {% for field in form %}
            <div class="mb-2">
              <label class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors|join:", " }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <button class="btn btn-primary">Publicar comentario</button>
      </form>
    {% else %}
      <div class="alert alert-light border mt-4">
        <small>Iniciá sesión para comentar.</small>
      </div>
    {% endif %}
  </section>
</div>
{% endblock %}